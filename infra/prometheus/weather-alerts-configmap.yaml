apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-weather-rules
  namespace: default
data:
  weather-alerts.yaml: |
    groups:
    - name: weather-alerts
      rules:
      - alert: NoDataFromTelegraf
        expr: absent(weather_temperature_2m{job="telegraf"}) or changes(weather_temperature_2m{job="telegraf"}[3h]) == 0
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "No data from Telegraf for least 1 hour"
      - alert: HighPM25
        expr: pollution_components_pm2_5{job="telegraf"} > 25
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High PM2.5 level: {{ $value }} ug/m3 (normal <= 25)"
      - alert: WeatherPodFrequentRestarts
        expr: changes(kube_pod_container_status_restarts_total{pod=~"weather-.*"}[1h]) > 2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Pod weather перезапускается чаще 2 раз в час"
      - alert: WeatherPipelineStalled
        expr: probe_success{job="weather-website"} == 0
        for: 62m
        labels:
          severity: critical
        annotations:
          summary: "Нет данных на хостинге более 62 минут"
